Avatar - 淘宝阿凡达 基于软件包的应用服务克隆系统

<wiki:toc max_depth="1" />

==系统介绍与定位==

淘宝阿凡达是一个基于软件包管理的应用快照和克隆系统，利用软件包管理器的特性实现了对应用节点快照和还原功能，它可以把应用服务节点的软件包状态抓取下来存成文本文件，用户可以根据这个文本文件记录的信息使用阿凡达程序从淘宝的软件仓库服务器中获取相应的软件包安装到操作系统上，从而达到了应用克隆的功能。

一个容易理解的比喻是——“阿凡达系统可以提取应用服务的DNA信息并克隆出该应用服务”。

系统设计目的是为了简化部署流程、提高部署精度和速度；对于日常生产运维的直接收益就是“将现有复杂的安装命令简化至一条*短*命令”，从而大大降低了安装部署时操作失误引发的风险和复杂命令和不同场景行为差异带来的困惑；通过自身的功能和特征，阿凡达系统将使得工程师对应用和服务的重塑、还原、克隆、回滚等工作变得异常简单，使得开发到测试、生产之间的应用传递环节和过程变得更加简洁透明和轻松，达到大幅降低沟通和管理成本的战略目标。

*系统功能范围：
**承担的功能：用于进行操作系统软件包、应用软件包的安装部署、还原及回滚
**不承担的功能：操作系统本身的安装 应用软件使用上的配置调整和改动（视应用配置复杂程度而定）

==系统功能概要==

###构建应用的软件包模型的存储形式为"单一文本文件"
###文件版本控制和日志记录
###软件包模型信息可由中央服务器任意获取
###多用户操作及用户操作权限控制
###命名空间支持Range表达式
###软件包快照抓取方式CLI和WEB
###可通过CLI或WEB提交软件包快照文件


==系统架构图==


==用户/系统流程图==



==软件包与软件仓库==

我们目前使用的是RPM软件包，用yum作为软件包分发服务器 软件包信息可以在 http://yum.corp.taobao.com 上查询

==命名空间(namespace)说明==

*命名规则
可按主机名 例如： dumyhost.cm4，主机组 例如： item_center_cm4，自定义命名 例如：httpd-server，语法支持range, 例如：abc[1-10,15].cm5

*校验规则
部分重名不可提交

完全重名可提交 avatar客户端指定--namespace

==系统软件包和应用软件包的分离==

RedHat系统上安装软件包数量庞大，我们利用RPM的Group已有命名和指定自定义软件包的方式实现 "石头"与"沙子"的分离，

== 软件包状态信息格式==

*namespace 即为 命名空间

按主机名 例如：

 dumyhost.cm4

主机组 例如： 

 item_center_cm4

自定义命名 例如：

 httpd-server

语法支持range, 例如：

 abc[1-10,15].cm5

*timestamp 为 该状态信息最后更改时间

*base_rpms_num 为 系统软件包的数量

需为完整描述(包名-版本号-发行号.架构), 例如：

 libdbi-dbd-pgsql-0.8.1a-1.2.2.x86_64

*cust_rpms_num 为 自定义软件包的数量

需为完整描述(包名-版本号-发行号.架构), 例如：

 tsar-2.1.0-1250.el5.x86_64

*base_rpms 为 系统软件包明细

*cust_rpms 为 自定义软件包明细

*diff_files 为 所要打patch的文件明细

格式为 文件名1 空格 文件名2 例： 

 "/usr/local/tsar/conf/tsar.conf.diff /home/a/share/ECPM/Merge/conf/merge.conf.diff" 

*diff实体内容 在###END OF AVATAR###后为diff实体内容 

格式为：文件名 换行 diff内容 换行 下一个文件名 换行 内容 …… 例：

 /home/a/share/ECPM/Merge/conf/merge.conf.diff



[[File:Avatar_-_Transation_Format_-_2010-08-23.png]]

== 软件包还原/安装程序 WallE==

===安装方法===

yum install walle -b current

===使用方法===

Wall-E:I am a Avatar Installer @Taobao Inc.
Usage:
    walle.sh [-n] [-r] ..[options]

        -n              use namespace ''使用名为namespace的Avatar信息''
        -r              use revision ''使用指定版本''
        -k              skip base rpm check.''跳过系统基础包检测和系统包处理 在已知系统软件健全时使用 会节省安装时间''
        -N              don't patch specified diff files
        -f              use local avatar file. ''使用本地文件作为Avatar信息''
        -c              print summary report only, not perform install.''只生成报告 不执行安装''
        -y              skip perform confirm prompt.''跳过执行提示交互，直接执行''
        -H              show Wall-E performed history.''显示Wall-E执行历史''
        -h              print this help message.''显示帮助信息''
        -v              verbose output.''调试模式''
        -V              print version.''显示版本信息''
        -t              Ask no questions to patch command; skip bad-Prereq patches; assume reversed 跳过patch的已patch提问，直接patch


一个部署/安装/回滚的显示过程： 

== 软件包状态捕获程序 Avatar==

===安装方法===

yum install avatar -b current

===使用方法===

 Avatar - Avatar Fetcher, Taobao Inc.
 Usage:
    avatar.pl [options]
 Options:
     -h/--help                           Help 显示帮助信息
     -v/--verbose                Run commands in verbose mode 调试模式，显示更多信息
     -c/--cust                           divsion customer packages 指定自定义包
     -n/--namespace      use specified namespace 指定命名空间
     -s/--save                           save avatar to <namespace>.avatar 保存状态信息至文件
     -f/--file                           use exist avatar file instead fetch snap 使用已有状态信息文件提交

一个捕获并提交的显示过程：

 ./avatar.pl -n item[1-100].cm4 <-指定namespace而不是本机主机名
 Enter your svn account: buping <-svn帐号
 Enter your svn password: <-svn密码
 Enter Avatar Commit Comment (> 20 letters): taobao avatar test taobao avatar test taobao avatar test <-svn提交说明
 INFO:Fetching Avatar...
 INFO:Commiting...
 MESSAGE:Avatar commited successfuly <-成功提交提示

==阿凡达信息的继承功能==

配置继承是阿凡达系统提供的一个便利功能，能够基于已有的avatar信息进行增删配置的条目

例：


==Web管理界面==

可以在Web界面上添加、搜索、编辑Avatar信息

==用户使用手册==

注意：应用克隆尽量在对等操作系统之间进行已达到准确、快捷效果

*构建应用服务原型机
**使用RPM软件包安装应用服务程序
**编辑应用服务配置

*获取应用原型机软件快照

**安装快照抓取程序avatar
 yum install avatar -b current
**抓取快照
 avatar -n [namespace]

*使用快照克隆
**安装克隆程序walle
 yum install avatar -b current
**克隆应用
 walle -n [namespace]

==应用情景与案例==

    * 直接抓取提交(以主机名做namespace) avatar
    * 保存avatar至本地 avatar -s
    * 提交已抓获avatar文件 avatar -f [filename]
    * 指定namespace 抓取 avatar -n
    * 根据默认avatar还原(以主机名做namespace) walle
    * 根据avatar文件还原 walle -n [namespace]
    * 编辑avatar文件 vi [namespace].avatar
    * 在线编辑avatar
    * 版本控制 覆盖提交/根据版本还原 walle -n [namespace] -r [revision]

批量部署/安装/还原/回滚

 assh -h host[1-100].cm4 "wall -n click_page"

==Avatar配置存储目录 TreeOfSouls==


==API接口==


GET Avatar 用于获取软件包模型信息内容

参数 namespace 命名空间 revision 版本号 不指定则为last revision


POST Avatar 用于接收软件包信息内容


==版本说明==

avatar 和 walle属于与系统版本架构无关的程序，avatar需要LWP/MIME/Term/HTTP等常见PerlModule，通常已安装，如不存通过yum会自动安装 walle需要bash > 3.0

name-major-junior-patch-release

major是主版本，现在定义为 0

junior是次版本现在定义为 1

patch是补丁版本

release代表发行程序用途 目前内测版是alpha

版本号随发行递增


==常见问题==

 '''执行avatar抓取快照时提示Permission Denied'''

 部分文件放到了root才可读的目录下，使用sudo avatar进行抓取

 '''Patch时提示 Reversed (or previously applied) patch detected!  Assume -R? [n] 发现已被patch过的文件'''

 选择回答默认n或直接回车则跳过，则不更改conf文件

 选择回答y则进行反向patch

 '''Patch结果为空内容'''

 配置文件反复覆盖引起的，比如一个文件隶属于2个及2个以上的包会导致文件发生改变

 '''avatar抓取状态时如果是中文环境则抓取的信息列表不正确'''

 会出现类似 群組 Amusements/Graphics 不包含任何套件 的信息，暂无解决办法，有可能多种语言输出 建议改成英文信息输出